{% extends "base.html" %}

{% block title %}分類分析{% endblock %}

{% block head %}
<style>
/* 基礎樣式變量 */
:root {
    --primary-color: #0066FF;      /* Apple 藍色 */
    --success-color: #34C759;      /* Apple 綠色 */
    --danger-color: #FF3B30;       /* Apple 紅色 */
    --warning-color: #FF9500;      /* Apple 橙色 */
    --secondary-text: #8E8E93;     /* Apple 次要文本 */
    --border-color: #E5E5EA;       /* Apple 邊框色 */
    --card-bg: #FFFFFF;
    --hover-bg: #F2F2F7;          /* Apple 系統懸停色 */
}

/* 頁面布局樣式 */
.page-header {
    display: grid;
    grid-template-columns: auto minmax(auto, 300px) auto minmax(auto, 300px); /* 四列布局 */
    align-items: center;
    gap: 24px;
    padding: 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--bg-color);
    margin: -20px -20px 24px -20px;
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: saturate(180%) blur(20px);
    background-color: rgba(245, 245, 247, 0.8);
}

/* 標題保持左對齊 */
.page-title {
    font-size: 28px;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

/* 分類選擇器居中 */
.category-selector {
    justify-self: center;  /* 在第二列中居中 */
    position: relative;
    min-width: 160px;
    height: 36px;
    display: flex;
    align-items: center;
}

/* 當前選中的分類容器 */
#selectedCategory {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;  /* 繼承父容器高度 */
}

/* 修改分類選擇器的內邊距，減小整體高度 */
#selectedCategory .category-pill {
    padding: 6px 16px;  /* 減小內邊距 */
    font-size: 20px;
    height: 36px;  /* 固定高度 */
    display: flex;
    align-items: center;
}

#selectedCategory .category-pill .icon {
    width: 10px;         /* 減小圖標，從12px改為10px */
    height: 10px;
}

/* 分類標簽網格 */
.category-pills {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
    padding: 4px;
    transition: opacity 0.2s ease, transform 0.2s ease;
}

/* 展開時的分類選擇面板 */
.category-expanded {
    position: absolute;
    top: calc(100% + 8px); /* 保持原有間距 */
    left: 50%;
    transform: translateX(-50%) translateY(0);
    background: var(--bg-color);
    border-radius: 16px;
    padding: 16px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    backdrop-filter: saturate(180%) blur(20px);
    background-color: rgba(245, 245, 247, 0.95);
    z-index: 100;
    width: max-content;
    max-width: 90vw;
}

/* 添加連接區域 */
.category-expanded::before {
    content: '';
    position: absolute;
    top: -8px; /* 與 margin-top 相同 */
    left: 0;
    right: 0;
    height: 8px; /* 填充間隔區域 */
    background: transparent; /* 保持透明 */
}

/* 展開面板中的分類網格 */
.category-expanded .category-pills {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
    width: max-content;
    max-width: 800px; /* 限制最大寬度 */
}

/* 當父容器被hover時顯示展開面板 */
.category-selector:hover .category-expanded {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(-50%) translateY(0);
}

.category-pill {
    padding: 8px 16px;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
    color: var(--secondary-text);
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
}

.category-pill:hover {
    background: var(--hover-bg);
}

.category-pill.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.category-pill .icon {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* 移除滾動相關樣式 */
.category-selector::before,
.category-selector::after {
    display: none;
}

/* 統計卡片樣式 */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.stat-card h3 {
    font-size: 13px;
    font-weight: 500;
    color: var(--secondary-text);
    margin-bottom: 12px;
    letter-spacing: -0.01em;
}

.stat-card .value {
    font-size: 28px;
    font-weight: 600;
    color: var(--text-color);
    letter-spacing: -0.02em;
    font-family: var(--font-family-display);
}

.stat-card .trend {
    margin-top: 8px;
    font-size: 13px;
    color: var(--secondary-text);
}

/* 圖表卡片樣式 */
.chart-grid {
    display: grid;
    gap: 24px;
    margin-bottom: 24px;
}

.chart-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.chart-header {
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chart-title {
    font-size: 17px;
    font-weight: 600;
    color: var(--text-color);
    letter-spacing: -0.01em;
    font-family: var(--font-family-text);
}

.chart-controls {
    display: flex;
    gap: 12px;
}

.time-range-selector {
    justify-self: center;  /* 在第三列中居中 */
    display: flex;
    align-items: center;
    gap: 16px;
}

.time-range-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--card-bg);
    color: var(--secondary-text);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.time-range-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.time-range-btn:hover:not(.active) {
    background: var(--hover-bg);
}

.chart-container {
    height: 400px;
    width: 100%;
}

/* 展開面板中的分類保持原有大小 */
.category-expanded .category-pill {
    padding: 8px 16px;
    font-size: 14px;
}

.category-expanded .category-pill .icon {
    width: 8px;
    height: 8px;
}

/* 修改 header-controls 樣式 */
.header-controls {
    grid-column: 2;
    display: flex;
    align-items: center;
    gap: 48px;
    margin-left: 80px;
    height: 36px;  /* 限制高度 */
}

/* 修改時間控制區域樣式 */
.time-controls {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-left: 24px;
    height: 36px;  /* 限制高度 */
}

.time-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: var(--card-bg);
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.time-button:hover:not(:disabled) {
    background: var(--hover-bg);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.time-button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.time-display {
    position: relative;
    font-family: var(--font-family-display);
    font-size: 20px;
    font-weight: 600;
    color: var(--text-color);
    min-width: 120px;
    text-align: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.time-display:hover {
    background: var(--hover-bg);
}

.time-options {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(8px);
    background: var(--card-bg);
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    display: none;
    flex-direction: column;
    gap: 4px;
    min-width: 140px;
    backdrop-filter: saturate(180%) blur(20px);
    background-color: rgba(245, 245, 247, 0.95);
    z-index: 100;
}

.time-display:hover .time-options {
    display: flex;
}

.time-option {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: var(--text-color);
    font-size: 14px;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
}

.time-option:hover {
    background: var(--hover-bg);
}

.time-option.active {
    background: var(--primary-color);
    color: white;
}

/* 範圍切換控制靠右對齊 */
.range-selector {
    justify-self: end;  /* 在第四列中靠右對齊 */
    display: flex;
    background: var(--hover-bg);
    border-radius: 24px;
    padding: 3px;
}

.range-btn {
    padding: 8px 20px;  /* 減小內邊距，從10px 24px改為8px 20px */
    border: none;
    border-radius: 20px;  /* 調整圓角以匹配外部容器 */
    background: transparent;
    color: var(--secondary-text);
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 90px;      /* 增加最小寬度，從80px改為90px */
    text-align: center;
}

.range-btn.active {
    background: var(--card-bg);
    color: var(--primary-color);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    font-weight: 600;
}

.range-btn:hover:not(.active) {
    color: var(--text-color);
}

/* 時間選擇器樣式 */
.time-range-selector {
    display: flex;
    align-items: center;
    gap: 16px;          /* 增加按鈕間距 */
}

.time-button {
    width: 36px;        /* 增大按鈕尺寸 */
    height: 36px;
    border-radius: 18px;
}

.time-display {
    font-size: 24px;    /* 增大字體大小 */
    min-width: 140px;   /* 增加最小寬度 */
    font-weight: 600;
}

.time-button i {
    font-size: 16px;    /* 增大圖標大小 */
}

/* 移除舊的懸浮菜單樣式 */
.time-options {
    display: none;
}

/* 分類頁面標題區域樣式 */
.page-header {
    display: grid;
    grid-template-columns: auto minmax(auto, 300px) auto minmax(auto, 300px); /* 四列布局 */
    align-items: center;
    gap: 24px;
    padding: 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--bg-color);
    margin: -20px -20px 24px -20px;
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: saturate(180%) blur(20px);
    background-color: rgba(245, 245, 247, 0.8);
}

.page-title {
    font-size: 28px;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

/* 分類選擇器樣式 */
.category-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    grid-column: 2;
}

.category-display {
    font-family: var(--font-family-display);
    font-size: 24px;  /* 增大字體大小 */
    font-weight: 600;
    color: var(--text-color);
    min-width: 140px;  /* 增加最小寬度 */
    text-align: center;
    letter-spacing: -0.025em;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">分類分析</h1>
    <div class="category-selector">
        <div id="selectedCategory">
            <!-- 當前選中的分類 -->
        </div>
        <div class="category-expanded">
            <div class="category-pills" id="categoryPills">
                <!-- 所有分類 -->
            </div>
        </div>
    </div>
    <div class="time-range-selector">
        <button id="prevTime" class="time-button">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="time-display">
            <span id="timeDisplay">2024年</span>
        </div>
        <button id="nextTime" class="time-button">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    <div class="range-selector">
        <button class="range-btn" data-range="all">所有</button>
        <button class="range-btn active" data-range="year">年度</button>
        <button class="range-btn" data-range="month">月度</button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3>分類總支出</h3>
        <div class="value" id="totalExpense">--</div>
        <div class="trend">
            <span id="expenseCount">--</span>
            <span id="avgExpense" style="margin-left: 8px">--</span>
        </div>
    </div>
    <div class="stat-card">
        <h3>支出占比</h3>
        <div class="value" id="expenseRatio">--</div>
        <div class="trend">
            <span id="ratioTrend">--</span>
        </div>
    </div>
    <div class="stat-card">
        <h3>月均支出</h3>
        <div class="value" id="monthlyAvg">--</div>
        <div class="trend">
            <span id="monthlyTrend">--</span>
        </div>
    </div>
    <div class="stat-card">
        <h3>消費頻率</h3>
        <div class="value" id="frequency">--</div>
        <div class="trend">
            <span id="frequencyTrend">--</span>
        </div>
    </div>
</div>

<div class="chart-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h2 class="chart-title">支出趨勢</h2>
        </div>
        <div class="chart-container" id="trendChart"></div>
    </div>
</div>

<div class="chart-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h2 class="chart-title">消費規律分析</h2>
        </div>
        <div class="chart-container" id="patternChart"></div>
    </div>
</div>

<div class="chart-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h2 class="chart-title">金額分布</h2>
        </div>
        <div class="chart-container" id="distributionChart"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 添加金額格式化函數
function formatMoney(value) {
    // 如果是整數，不顯示小數位
    if (Number.isInteger(value)) {
        return new Intl.NumberFormat('zh-CN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }
    
    // 如果有小數，最多顯示兩位小數，但不強制顯示兩位
    return new Intl.NumberFormat('zh-CN', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(value);
}

document.addEventListener('DOMContentLoaded', function() {
    let trendChart = null;
    let patternChart = null;
    let distributionChart = null;
    let currentCategory = null;
    let currentTimeRange = 'year';  // 默認為年度
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let availableYears = [];
    let availableMonths = {};
    
    // 添加金額篩選功能
    let currentFilter = 'all';  // 當前篩選類型
    
    // 初始化圖表
    function initCharts() {
        trendChart = echarts.init(document.getElementById('trendChart'));
        patternChart = echarts.init(document.getElementById('patternChart'));
        distributionChart = echarts.init(document.getElementById('distributionChart'));
        
        // 響應窗口調整
        window.addEventListener('resize', function() {
            trendChart.resize();
            patternChart.resize();
            distributionChart.resize();
        });
    }
    
    // 修改加載分類的函數
    function loadCategories() {
        fetch('/api/category_analysis')
            .then(response => response.json())
            .then(data => {
                const allPillsContainer = document.getElementById('categoryPills');
                const selectedPillContainer = document.getElementById('selectedCategory');
                
                // 默認選中餐飲美食分類
                const defaultCategory = '飲食';
                selectedPillContainer.innerHTML = `
                    <div class="category-pill active" data-category="${defaultCategory}">
                        <span class="icon" style="background-color: ${window.getCategoryColor(defaultCategory)}"></span>
                        <span>${defaultCategory}</span>
                    </div>
                `;
                
                // 生成所有分類
                allPillsContainer.innerHTML = data.categories.map(category => `
                    <div class="category-pill${category === defaultCategory ? ' active' : ''}" data-category="${category}">
                        <span class="icon" style="background-color: ${window.getCategoryColor(category)}"></span>
                        <span>${category}</span>
                    </div>
                `).join('');

                // 綁定點擊事件
                document.querySelectorAll('.category-pill').forEach(pill => {
                    pill.addEventListener('click', function() {
                        const category = this.dataset.category;
                        
                        // 更新選中狀態
                        document.querySelectorAll('.category-pill').forEach(p => 
                            p.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 更新顯示的選中分類
                        selectedPillContainer.innerHTML = `
                            <div class="category-pill active" data-category="${category}">
                                <span class="icon" style="background-color: ${window.getCategoryColor(category)}"></span>
                                <span>${category}</span>
                            </div>
                        `;
                        
                        // 加載分類數據
                        loadCategoryData(category);
                    });
                });

                // 初始加載默認分類的數據
                loadCategoryData(defaultCategory);
            });
    }
    
    // 修改 HTML 中的初始按鈕狀態
    document.querySelector('.range-btn[data-range="year"]').classList.add('active');
    document.querySelector('.range-btn[data-range="month"]').classList.remove('active');

    // 添加時間控制相關函數
    function updateTimeDisplay() {
        const timeDisplay = document.getElementById('timeDisplay');
        const prevBtn = document.getElementById('prevTime');
        const nextBtn = document.getElementById('nextTime');
        
        if (currentTimeRange === 'all') {
            timeDisplay.textContent = '全部時間';
            // 在"所有"模式下禁用時間切換按鈕
            prevBtn.style.visibility = 'hidden';
            nextBtn.style.visibility = 'hidden';
        } else {
            // 恢覆時間切換按鈕的顯示
            prevBtn.style.visibility = 'visible';
            nextBtn.style.visibility = 'visible';
            
            if (currentTimeRange === 'year') {
                timeDisplay.textContent = `${currentYear}年`;
            } else {
                timeDisplay.textContent = `${currentYear}年${currentMonth}月`;
            }
        }
    }
    
    function updateTimeControls() {
        const prevBtn = document.getElementById('prevTime');
        const nextBtn = document.getElementById('nextTime');
        
        if (currentTimeRange === 'all') {
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }
        
        if (currentTimeRange === 'year') {
            const minYear = Math.min(...availableYears);
            const maxYear = Math.max(...availableYears);
            prevBtn.disabled = currentYear <= minYear;
            nextBtn.disabled = currentYear >= maxYear;
        } else if (currentTimeRange === 'month') {
            const currentYearMonths = availableMonths[currentYear] || [];
            const minMonth = Math.min(...currentYearMonths);
            const maxMonth = Math.max(...currentYearMonths);
            
            const isFirstMonth = currentMonth <= minMonth && currentYear <= Math.min(...availableYears);
            const isLastMonth = currentMonth >= maxMonth && currentYear >= Math.max(...availableYears);
            
            prevBtn.disabled = isFirstMonth;
            nextBtn.disabled = isLastMonth;
        }
    }
    
    // 修改範圍切換按鈕事件處理
    document.querySelectorAll('.range-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const range = this.dataset.range;
            
            // 更新按鈕狀態
            document.querySelectorAll('.range-btn').forEach(b => 
                b.classList.remove('active'));
            this.classList.add('active');
            
            // 更新時間範圍
            currentTimeRange = range;
            
            // 更新顯示
            updateTimeDisplay();
            updateTimeControls();
            
            // 重新加載數據
            if (currentCategory) {
                loadCategoryData(currentCategory);
            }
        });
    });
    
    // 恢覆 backup 版本的時間相關函數
    function loadAvailableDates() {
        fetch('/api/category_available_dates')
            .then(response => response.json())
            .then(data => {
                availableYears = data.years;
                availableMonths = data.months;
                
                // 設置默認年份為最新的年份
                currentYear = Math.max(...availableYears);
                // 設置默認月份為當年的最新月份
                currentMonth = Math.max(...availableMonths[currentYear]);
                
                updateTimeDisplay();
                updateTimeControls();
                loadCategories();  // 加載分類數據
            })
            .catch(error => {
                console.error('Error loading available dates:', error);
                showToast('加載日期數據失敗，請重試');
            });
    }
    
    // 修改時間切換按鈕事件
    document.getElementById('prevTime').addEventListener('click', function() {
        if (currentTimeRange === 'year' && currentYear > Math.min(...availableYears)) {
            currentYear--;
            // 切換年份時，設置月份為該年的最後一個月
            if (availableMonths[currentYear]) {
                currentMonth = Math.max(...availableMonths[currentYear]);
            }
        } else if (currentTimeRange === 'month') {
            if (currentMonth > 1) {
                currentMonth--;
            } else if (currentYear > Math.min(...availableYears)) {
                currentYear--;
                currentMonth = 12;
            }
            // 確保月份在可用範圍內
            if (availableMonths[currentYear]) {
                const validMonths = availableMonths[currentYear];
                if (!validMonths.includes(currentMonth)) {
                    currentMonth = Math.max(...validMonths.filter(m => m < currentMonth));
                }
            }
        }
        updateTimeDisplay();
        updateTimeControls();
        if (currentCategory) {
            loadCategoryData(currentCategory);
        }
    });
    
    document.getElementById('nextTime').addEventListener('click', function() {
        if (currentTimeRange === 'year' && currentYear < Math.max(...availableYears)) {
            currentYear++;
            // 切換年份時，設置月份為該年的第一個月
            if (availableMonths[currentYear]) {
                currentMonth = Math.min(...availableMonths[currentYear]);
            }
        } else if (currentTimeRange === 'month') {
            if (currentMonth < 12) {
                currentMonth++;
            } else if (currentYear < Math.max(...availableYears)) {
                currentYear++;
                currentMonth = 1;
            }
            // 確保月份在可用範圍內
            if (availableMonths[currentYear]) {
                const validMonths = availableMonths[currentYear];
                if (!validMonths.includes(currentMonth)) {
                    currentMonth = Math.min(...validMonths.filter(m => m > currentMonth));
                }
            }
        }
        updateTimeDisplay();
        updateTimeControls();
        if (currentCategory) {
            loadCategoryData(currentCategory);
        }
    });
    
    // 加載分類數據
    function loadCategoryData(category) {
        if (!category) return;
        
        const params = new URLSearchParams({
            category: category,
            range: currentTimeRange,
            year: currentYear.toString(),
            month: currentMonth.toString()
        });
        
        // 添加金額範圍參數
        if (currentFilter === 'large') {
            params.append('min_amount', '1000');
        } else if (currentFilter === 'small') {
            params.append('max_amount', '1000');
        }
        
        fetch(`/api/category_analysis?${params}`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        // 返回一個空數據結構
                        return {
                            category: category,
                            stats: {
                                total_expense: 0,
                                transaction_count: 0,
                                avg_amount: 0,
                                expense_ratio: 0,
                                max_amount: 0,
                                min_amount: 0,
                                median_amount: 0
                            },
                            trend: {
                                dates: [],
                                amounts: [],
                                counts: [],
                                ratios: []
                            },
                            pattern: {
                                hours: Array.from({length: 24}, (_, i) => i),
                                counts: Array(24).fill(0),
                                amounts: Array(24).fill(0),
                                averages: Array(24).fill(0)
                            },
                            distribution: {
                                ranges: ['0-50', '50-100', '100-200', '200-500', '500-1000', '1000+'],
                                counts: Array(6).fill(0),
                                percentages: Array(6).fill(0)
                            }
                        };
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                currentCategory = category;
                updateStats(data.stats);
                updateCharts(data);
            })
            .catch(error => {
                console.error('Error loading category data:', error);
                // 顯示錯誤狀態
                updateStats({
                    total_expense: 0,
                    transaction_count: 0,
                    avg_amount: 0,
                    expense_ratio: 0
                });
                // 清空圖表
                updateCharts({
                    trend: { dates: [], amounts: [], counts: [], ratios: [] },
                    pattern: {
                        hours: Array.from({length: 24}, (_, i) => i),
                        counts: Array(24).fill(0),
                        amounts: Array(24).fill(0),
                        averages: Array(24).fill(0)
                    },
                    distribution: {
                        ranges: ['0-50', '50-100', '100-200', '200-500', '500-1000', '1000+'],
                        counts: Array(6).fill(0),
                        percentages: Array(6).fill(0)
                    }
                });
            });
    }
    
    // 更新統計卡片
    function updateStats(stats) {
        // 更新總支出和交易筆數
        document.getElementById('totalExpense').textContent = `${formatMoney(stats.total_expense)} 元`;
        document.getElementById('expenseCount').textContent = `${stats.transaction_count} 筆交易`;
        document.getElementById('avgExpense').textContent = `平均 ${formatMoney(stats.avg_amount)} 元/筆`;
        
        // 更新支出占比
        document.getElementById('expenseRatio').textContent = `${stats.expense_ratio}%`;
        document.getElementById('ratioTrend').textContent = stats.total_expense > 0 ? '占總支出比例' : '暫無數據';
        
        // 根據時間範圍更新月均支出和交易頻率
        const monthlyAvgElement = document.getElementById('monthlyAvg');
        const monthlyTrendElement = document.getElementById('monthlyTrend');
        const frequencyElement = document.getElementById('frequency');
        const frequencyTrendElement = document.getElementById('frequencyTrend');
        
        if (currentTimeRange === 'all') {
            // 所有時間範圍
            const yearCount = Math.ceil(stats.date_range / 365); // 總天數轉換為年數
            const monthlyAvg = stats.total_expense / (stats.date_range / 30); // 按30天一個月計算
            monthlyAvgElement.textContent = `${formatMoney(monthlyAvg)} 元`;
            monthlyTrendElement.textContent = '歷史月均支出';
            
            const frequency = stats.transaction_count / stats.date_range;
            frequencyElement.textContent = `${frequency.toFixed(1)} 次`;
            frequencyTrendElement.textContent = '歷史日均交易';
            
        } else if (currentTimeRange === 'year') {
            // 年度範圍
            const monthlyAvg = stats.total_expense / 12;
            monthlyAvgElement.textContent = `${formatMoney(monthlyAvg)} 元`;
            monthlyTrendElement.textContent = '月均支出';
            
            const frequency = stats.transaction_count / 365;
            frequencyElement.textContent = `${frequency.toFixed(1)} 次`;
            frequencyTrendElement.textContent = '日均交易頻率';
            
        } else {
            // 月度範圍
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            monthlyAvgElement.textContent = `${formatMoney(stats.total_expense)} 元`;
            monthlyTrendElement.textContent = '本月支出';
            
            const frequency = stats.transaction_count / daysInMonth;
            frequencyElement.textContent = `${frequency.toFixed(1)} 次`;
            frequencyTrendElement.textContent = '日均交易頻率';
        }
    }
    
    // 更新圖表
    function updateCharts(data) {
        // 檢查是否有數據
        const hasData = data.trend.dates && data.trend.dates.length > 0;
        
        // 支出趨勢圖配置
        const trendOption = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'  // 改用十字準星指示器
                },
                formatter: function(params) {
                    if (!hasData) return '暫無數據';
                    const date = params[0].name;
                    const amount = params[0].value;
                    const ratio = params[1].value;
                    const count = data.trend.counts[params[0].dataIndex];
                    let dateLabel;
                    if (currentTimeRange === 'all') {
                        dateLabel = `${date}年`;
                    } else if (currentTimeRange === 'year') {
                        dateLabel = `${date.split('-')[0]}年${date.split('-')[1]}月`;
                    } else {
                        dateLabel = date;
                    }
                    return `${dateLabel}<br/>
                            支出：${formatMoney(amount)} 元<br/>
                            占比：${ratio.toFixed(1)}%<br/>
                            筆數：${count} 筆<br/>
                            均值：${formatMoney(amount/count)} 元/筆`;
                }
            },
            legend: {
                data: ['支出金額', '支出占比'],
                top: 10,
                right: 10
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: hasData ? data.trend.dates : [],
                axisLabel: {
                    formatter: value => {
                        if (currentTimeRange === 'all') {
                            return value + '年';
                        } else if (currentTimeRange === 'year') {
                            return value.split('-')[1] + '月';
                        } else {
                            return value.split('-')[2] + '日';
                        }
                    }
                }
            },
            yAxis: [{
                type: 'value',
                name: '金額 (元)',
                position: 'left',
                axisLabel: {
                    formatter: value => formatMoney(value)
                }
            }, {
                type: 'value',
                name: '占比 (%)',
                position: 'right',
                splitLine: { show: false },
                axisLabel: {
                    formatter: '{value}%'
                }
            }],
            series: [{
                name: '支出金額',
                type: 'bar',
                data: hasData ? data.trend.amounts : [],
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: window.getCategoryColor(currentCategory) + 'CC'  // 稍微透明一些
                    }, {
                        offset: 1,
                        color: window.getCategoryColor(currentCategory) + '99'
                    }]),
                    borderRadius: [4, 4, 0, 0]
                },
                emphasis: {
                    focus: 'none',  // 不要讓其他系列變暗
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0,
                            color: window.getCategoryColor(currentCategory)
                        }, {
                            offset: 1,
                            color: window.getCategoryColor(currentCategory) + 'CC'
                        }])
                    }
                },
                barWidth: '60%',
                z: 1
            }, {
                name: '支出占比',
                type: 'line',
                yAxisIndex: 1,
                data: hasData ? data.trend.ratios : [],
                symbol: 'circle',
                symbolSize: 8,
                lineStyle: {
                    width: 3,
                    type: 'solid',
                    color: '#6366f1'  // 使用不同的顏色
                },
                itemStyle: {
                    color: '#6366f1',
                    borderWidth: 2,
                    borderColor: '#ffffff'
                },
                emphasis: {
                    focus: 'none',
                    scale: true,
                    itemStyle: {
                        borderWidth: 3
                    }
                },
                z: 2,
                smooth: 0.2  // 添加輕微的平滑效果
            }]
        };

        // 消費規律分析圖配置
        const patternOption = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            legend: {
                data: ['交易次數', '交易金額'],
                top: 0
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: data.pattern.hours.map(h => `${h}時`),
                axisLabel: {
                    interval: 0
                }
            },
            yAxis: [{
                type: 'value',
                name: '交易次數',
                position: 'left'
            }, {
                type: 'value',
                name: '交易金額',
                position: 'right',
                axisLine: { show: true },
                axisLabel: {
                    formatter: value => formatMoney(value)
                }
            }],
            series: [{
                name: '交易金額',
                type: 'line',
                yAxisIndex: 1,
                data: data.pattern.amounts,
                itemStyle: {
                    color: window.getCategoryColor(currentCategory)
                },
                symbol: 'circle',
                symbolSize: 8,
                lineStyle: {
                    width: 3
                },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: window.getCategoryColor(currentCategory) + '40'
                    }, {
                        offset: 1,
                        color: window.getCategoryColor(currentCategory) + '00'
                    }])
                },
                z: 1
            }, {
                name: '交易次數',
                type: 'bar',
                data: data.pattern.counts,
                itemStyle: {
                    color: 'rgba(128, 128, 128, 0.3)',
                    borderRadius: [4, 4, 0, 0]
                },
                z: 2
            }]
        };

        // 金額分布圖配置
        const distributionOption = {
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    if (!hasData) return '暫無數據';
                    const range = params[0].name;
                    const count = params[0].value;
                    const total = data.distribution.counts.reduce((a, b) => a + b, 0);
                    const percentage = ((count / total) * 100).toFixed(1);
                    return `金額範圍：${range}<br/>
                            交易筆數：${count} 筆<br/>
                            占比：${percentage}%`;
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: data.distribution.ranges,
                axisLabel: {
                    interval: 0,
                    fontSize: 12
                }
            },
            yAxis: {
                type: 'value',
                name: '交易次數'
            },
            series: [{
                type: 'bar',
                data: data.distribution.counts.map((count, index) => ({
                    value: count,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0,
                            color: window.getCategoryColor(currentCategory)
                        }, {
                            offset: 1,
                            color: window.getCategoryColor(currentCategory) + '80'
                        }]),
                        borderRadius: [4, 4, 0, 0]
                    }
                }))
            }]
        };

        // 如果沒有數據，添加空狀態提示
        if (!hasData) {
            [trendOption, patternOption, distributionOption].forEach(option => {
                option.graphic = [{
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: '暫無數據',
                        fill: '#999',
                        font: '14px sans-serif'
                    }
                }];
            });
        }

        // 設置圖表配置
        trendChart.setOption(trendOption, true);  // 添加 true 參數以清除之前的配置
        patternChart.setOption(patternOption, true);
        distributionChart.setOption(distributionOption, true);

        // 為消費規律分析圖添加點擊事件
        patternChart.off('click');
        patternChart.on('click', function(params) {
            if (params.componentType === 'series') {
                const hour = parseInt(params.name);
                const title = `${currentCategory} - ${hour}時段交易明細`;
                
                // 構建查詢參數
                const queryParams = new URLSearchParams({
                    category: currentCategory,
                    hour: hour.toString(),
                    range: currentTimeRange,
                    year: currentYear.toString()
                });

                if (currentTimeRange === 'month') {
                    queryParams.append('month', currentMonth.toString());
                }

                // 添加金額篩選參數
                if (currentFilter === 'large') {
                    queryParams.append('min_amount', '1000');
                } else if (currentFilter === 'small') {
                    queryParams.append('max_amount', '1000');
                }
                
                fetch(`/api/transactions?${queryParams}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showTransactionModal(title, data.transactions);
                    })
                    .catch(error => {
                        console.error('Error fetching transaction data:', error);
                    });
            }
        });

        // 為金額分布圖添加點擊事件
        distributionChart.off('click');
        distributionChart.on('click', function(params) {
            if (params.componentType === 'series') {
                const range = params.name;
                let title;
                
                // 構建基礎查詢參數
                const queryParams = new URLSearchParams({
                    category: currentCategory
                });

                // 解析金額範圍
                let [min, max] = range.split('-').map(num => parseFloat(num) || 0);
                if (range.endsWith('+')) {
                    min = parseFloat(range.replace('+', ''));
                    max = Infinity;
                }
                queryParams.append('min_amount', min.toString());
                queryParams.append('max_amount', max === Infinity ? 'Infinity' : max.toString());

                // 根據當前時間範圍添加不同的參數
                if (currentTimeRange === 'all') {
                    title = `${currentCategory} - ${range}元交易明細（所有時間）`;
                } else if (currentTimeRange === 'year') {
                    title = `${currentCategory} - ${range}元交易明細（${currentYear}年）`;
                    queryParams.append('year', currentYear.toString());
                } else if (currentTimeRange === 'month') {
                    title = `${currentCategory} - ${range}元交易明細（${currentYear}年${currentMonth}月）`;
                    queryParams.append('year', currentYear.toString());
                    queryParams.append('month', currentMonth.toString());
                }

                // 添加時間範圍參數
                queryParams.append('range', currentTimeRange);

                // 獲取交易記錄
                fetch(`/api/transactions?${queryParams}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showTransactionModal(title, data.transactions);
                    })
                    .catch(error => {
                        console.error('Error fetching transaction data:', error);
                        showToast('獲取交易數據失敗，請重試');
                    });
            }
        });

        // 為趨勢圖添加點擊事件
        trendChart.off('click');
        trendChart.on('click', function(params) {
            if (params.componentType === 'series' && params.seriesName === '支出金額') {
                const date = params.name;
                let title, queryParams;
                
                // 構建基礎查詢參數
                queryParams = new URLSearchParams({
                    category: currentCategory
                });

                // 根據當前時間範圍添加不同的參數
                if (currentTimeRange === 'all') {
                    title = `${currentCategory} - ${date}年交易明細`;
                    queryParams.append('year', date);
                } else if (currentTimeRange === 'year') {
                    const [year, month] = date.split('-');
                    title = `${currentCategory} - ${year}年${month}月交易明細`;
                    queryParams.append('year', year);
                    queryParams.append('month', month);
                } else {
                    title = `${currentCategory} - ${date}交易明細`;
                    queryParams.append('date', date);
                }

                // 添加金額篩選參數
                if (currentFilter === 'large') {
                    queryParams.append('min_amount', '1000');
                } else if (currentFilter === 'small') {
                    queryParams.append('max_amount', '1000');
                }

                // 獲取交易記錄
                fetch(`/api/transactions?${queryParams}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showTransactionModal(title, data.transactions);
                    })
                    .catch(error => {
                        console.error('Error fetching transaction data:', error);
                        showToast('獲取交易數據失敗，請重試');
                    });
            }
        });
    }
    
    // 綁定金額過濾按鈕事件
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // 更新按鈕狀態
            document.querySelectorAll('.filter-btn').forEach(b => 
                b.classList.remove('active'));
            this.classList.add('active');
            
            // 獲取過濾類型
            currentFilter = this.dataset.filter;
            
            // 重新加載數據
            if (currentCategory) {
                const params = new URLSearchParams({
                    category: currentCategory,
                    range: currentTimeRange,
                    year: currentYear.toString(),
                    month: currentMonth.toString()
                });
                
                // 添加金額範圍參數
                if (currentFilter === 'large') {
                    params.append('min_amount', '1000');
                } else if (currentFilter === 'small') {
                    params.append('max_amount', '1000');
                }
                
                // 重新加載分類數據
                fetch(`/api/category_analysis?${params}`)
                    .then(response => response.json())
                    .then(data => {
                        updateStats(data.stats);
                        updateCharts(data);
                    });
            }
        });
    });
    
    // 初始化
    initCharts();
    loadAvailableDates();  // 這會觸發後續的初始化流程
});
</script>
{% endblock %} 